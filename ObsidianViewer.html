<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="description" content="A viewer for my Obsidian Markdown files.">
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>MicahB.Dev | Markdown Viewer</title>
        <script src="https://cdn.jsdelivr.net/npm/@excalidraw/utils@0.1.2/dist/excalidraw-utils.min.js"></script>
        <script>
            const backend = "."
            let CurrentBaseDocument = "";
            async function GetSuggestedLinks() {
                const files = await (await fetch(backend + "/Modules/Search.js&term=.md")).json();
                const ul = document.createElement("ul");
                files.result.forEach(file => {
                    if (file.includes("md")) {
                        const part = document.createElement("li");
                        const link = document.createElement("a");
                        link.text = file.substring(0, file.indexOf(".md"));
                        link.onclick = function() { 
                            Load(file);
                            return pressedKeys != undefined ? (pressedKeys[16] != undefined) : false;
                        };
    
                        const newAddr = window.location.href.split('?')[0] + "?file=" + file;
                        link.href = newAddr;
    
                        part.appendChild(link);
                        ul.appendChild(part);
                    }
                });
                // Clear and add text.
                document.getElementById("Home").innerHTML = "<h1>Checkout these pages:</h1>"
                document.getElementById("Home").appendChild(ul);
                document.getElementById("Home").hidden = false;
                document.getElementById("Content").hidden = true;
                document.getElementById("ButtonContainer").hidden = true;
            }
            
            /**
             * @returns {Promise<Response>}
             */
            async function post(URL, data) {
                return fetch(backend + URL, {
                    method: "POST",
                    body: data
                })
            }
    
            function ProcessLink(match) {
                const href = match.href.toLowerCase();
                console.log("Processing link to " + href)
                if (href.includes("micahb.dev") && href.includes(".md")) {
                    // Check if there's an ! before the link. If so, embed the page.
                    let Address = match.href.substring(match.href.indexOf("=") + 1);
                    let ScrollTo = match.getAttribute("search");

                    const newPage = decodeURI(Address);
                    if (match.getAttribute("embed") == "true") {
                        const newPart = document.createElement("div");
                        const docName = newPage.substring(newPage.lastIndexOf("\\") + 1);
                        newPart.id = "Embed_" + docName + "_" + Math.floor(Math.random() * 10000);
                        newPart.setAttribute("embed", true);
                        newPart.setAttribute("document", docName)
                        match.parentElement.replaceChild(newPart, match); // Parent is never null here. 
    
                        // Note, use a settimeout for loading in order to ensure that this document finishes processing first. 
                        Load(newPage, newPart.id);
                    } else {
                        // Allows for crawling links while also cutting down on load times. 
                        match.onclick = function(evt) {
                            Load(newPage).then(e => {
                                // Scroll to the highlighted element
                                if (ScrollTo != undefined) {
                                    // Get all headings.
                                    let headings = [
                                        document.getElementsByTagName("h1"),
                                        document.getElementsByTagName("h2"),
                                        document.getElementsByTagName("h3"),
                                        document.getElementsByTagName("h4"),
                                        document.getElementsByTagName("h5"),
                                        document.getElementsByTagName("h6")
                                    ];

                                    // Loop through all headings.
                                    FindLoop:
                                    for (let j = 0; j < headings.length; j++) {
                                        const headingType = headings[j];
                                        for (let i = 0; i < headingType.length; i++) {
                                            const h = headingType[i];

                                            if (h.innerText == ScrollTo) {
                                                h.scrollIntoView({ behavior: 'smooth' });
                                                break FindLoop;
                                            }
                                        }
                                    }
                                }
                            })
    
                            // Return true: Calls href. Return false: Does nothing.
                            // Allow for shift-click to open in a new tab.
                            if (pressedKeys != undefined && pressedKeys[16] == true) return true;
                            else {
                                evt.preventDefault();
                                return false;
                            }
                        };
    
                        // Change the HREF to point to this page with that new address.
                        const newAddr = window.location.href.split('?')[0] + "?file=" + match.href.substring(match.href.indexOf("=") + 1);
                        match.href = newAddr;
                    }
                } else {
                    match.setAttribute("external", true);
    
                    // Follow it with an after image.
                    const AfterImage = document.createElement("externallinkafterimage");
                    match.after(AfterImage);
                }
            }
    
            const LoadingText = "Loading...";
            async function Load(path, LoadToElement = "Content") {
                return new Promise(async (res, rej) => {
                    try {
                        // First, fetch the HTML from the server and load it in.
                        const isBaseDocument = LoadToElement == "Content";
    
                        let page = await post("/Post_Modules/GetMDHTML.js", JSON.stringify({ location: path }));
                        let backlinksRequest;
                        const Element = document.getElementById(LoadToElement);
                        const FileName = path.substring(path.lastIndexOf("\\") + 1);
                        Element.innerHTML = LoadingText;
    
                        // Next, put the title of the page on screen.
                        if (isBaseDocument) {
                            CurrentBaseDocument = path;
                            const title = document.createElement("h1");
                            title.innerText = path.substring(path.lastIndexOf("\\") + 1, path.includes(".md") ? path.indexOf(".md") : path.length);
                            Element.prepend(title);

                            // Ask for backlinks early on. This saves a few ms.
                            backlinksRequest = post("/Post_Modules/GetBacklinks.js", JSON.stringify({ path: FileName.substring(0, FileName.length - 3) }));
                        }
    
                        // Unhide the content panel and hide the home panel.
                        Element.removeAttribute("hidden");
                        document.getElementById("Home").setAttribute("hidden", true);
                            // Also show buttons.
                        document.getElementById("ButtonContainer").removeAttribute("hidden");

                        // ExcalidrawUtils is a global variable defined by excalidraw.min.js
                        const { exportToSvg } = ExcalidrawUtils;
    
                        // First, decide if it's an Excalidraw document or a normal one.
                        if (!path.includes(".excalidraw.md")) {
                            page = await (await page).text();
                            Element.innerHTML = Element.innerHTML.replace(LoadingText, "") + page;
                            // If it isn't, Replace <a>'s with working ones.
                            const Anchors = Element.getElementsByTagName("a"); // Element.innerHTML.match(/<\s*a[^>]*>(.*?)<\s*\/\s*a\s*>/g);
                            for (let AnchorIndex = 0; AnchorIndex < Anchors.length; AnchorIndex++) {
                                const match = Anchors[AnchorIndex];
        
                                // Wait for 10ms to ensure that the next one is also scheduled.
                                setTimeout(() => {
                                    ProcessLink(match)
                                }, 10);
                            }
        
                            const Quotes = Element.getElementsByTagName("blockquote");
                            for (let i = 0; i < Quotes.length; i++) {
                                let quote = Quotes[i];
                                // Look for a style tag:
                                /** @type {String} */
                                const text = quote.innerText;
                                let title = text.match(/\[![A-Za-z0-9]+\]/);
                                if (title != null) {
                                    const match = title[0];
                                    quote.innerText = quote.innerText.replace(title[0], "");
                                    const param = match.substring(2, match.length - 1);
                                    quote.setAttribute(param, true);
                                    quote.innerHTML = `<h3 style="margin: 0%">${param.substring(0, 1).toUpperCase()}${param.substring(1)}</h3>` + quote.innerHTML;
                                }
                            }
        
                            const Tags = Element.getElementsByTagName("p");
                            tagLoop:
                            for (let i = 0; i < Tags.length; i++) {
                                const match = Tags[i].innerText.match(/\{TAG:.+\}/);
                                if (match != null) {
                                    const tag = match[0], inside = tag.substring(5, tag.length - 1);
        
                                    const NewTag = document.createElement("a");
                                    NewTag.setAttribute("tag", true);
                                    NewTag.innerHTML = `<b>#</b>${inside}`;
        
                                    /*
                                    for (let i = 0; i < Tags[i].children; i++) {
                                        if (Tags[i].children[i].innerText.includes(tag)) {
                                            Tags[i].children[i].innerText = Tags[i].children[i].innerText.replace(tag, "");
                                            Tags[i].prepend(NewTag);
                                            continue tagLoop;
                                        }
                                    }
                                    */
        
                                    Tags[i].innerHTML = Tags[i].innerHTML.replace(tag, "");
                                    Tags[i].prepend(NewTag);
                                }
                            }
        
                            // Fix redirected media images.
                            const Images = Element.getElementsByTagName("img");
                            const folder = path.substring(0, path.lastIndexOf("\\"));
        
                            for (let i = 0; i < Images.length; i++) {
                                const image = Images[i];
                                if (image.src.includes("/Media/")) image.src = image.src.replace("/Media/", "/" + folder + "/Media/");
                            };

                            // The bulk of the loading is now finished so we can just cut it there.
                            res();

                            // Look for <YBN id={Whatever}> embeds:
                            const YBNotes = Element.getElementsByTagName("YBN");
                            for (let i = 0; i < YBNotes.length; i++) {
                                const NotebookElement = YBNotes[i];
                                const id = NotebookElement.getAttribute("id");
                                const NotebookDirectory = backend + "/Converted_YBN_Notebooks/" + id + "/";

                                // Get pages.
                                fetch(NotebookDirectory + "pages.json").then(v => v.json()).then(json => {
                                    json.pages.forEach(page => {
                                        const part = document.createElement("div");
                                        NotebookElement.appendChild(part);
                                        fetch(NotebookDirectory + page + ".excalidraw.json").then(v => v.json()).then(eJSON => {
                                            // Convert the page to SVG.
                                            const svg = exportToSvg(eJSON);
                                            svg.then(v => {
                                                // Enable scaling.
                                                v.setAttribute("preserveAspectRatio", "xMidYMid meet");
                                                v.removeAttribute("width"); v.removeAttribute("height");
                                                part.appendChild(v);
                                            })
                                        })
                                    })
                                })
                            }

                        }
                        else {
                            // If it is, convert it to SVG.
                            page = await (await page).json();
                            const svg = exportToSvg(page);
                            svg.then(
                            /** @type {HTMLElement} */    
                            v => {
                                // Enable scaling.
                                v.setAttribute("preserveAspectRatio", "xMidYMid meet");
                                v.removeAttribute("width"); v.removeAttribute("height");
                                Element.innerHTML = Element.innerHTML.replace(LoadingText, "");
                                Element.appendChild(v);
                            })
                        }
                        
                        // Only update history and show backlinks for base document.
                        if (isBaseDocument) {
                            // Update the page title.
                            document.title = "MicahB.Dev | " + FileName;
                            
                            // Update history so people can share links easily. 
                            window.history.pushState({}, null, window.location.href.split('?')[0] + "?file=" + path);
                            
                            // Finally, add the backlinks.
                            const backlinks = await (await backlinksRequest).json();
                            if (backlinks.successful && backlinks.links.length > 0) {
                                const BackLinkDiv = document.createElement("div");
                                const Header = document.createElement("h2");
                                Header.innerText = "Backlinks: ";
                                BackLinkDiv.appendChild(Header);
                                const List = document.createElement("ul");
                                backlinks.links.forEach(link => {
                                    const item = document.createElement("li");
                                    const el = document.createElement("a");
    
                                    el.onclick = function() { 
                                        Load(link);
                                    }
                                    el.innerText = link;
    
                                    item.appendChild(el);
                                    List.appendChild(item);
                                });
                                BackLinkDiv.appendChild(List);
    
                                Element.appendChild(BackLinkDiv);
                            }
                        }
                    } catch (e) {
                        console.log(e)
                        rej(e);
                    }
                })
            }
    
            function UpdatePageFromParams() {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has("file")) {
                    setTimeout(() => {
                        Load(urlParams.get("file"));
                    }, 500);
                } else {
                    GetSuggestedLinks();
                }
            }

            async function Reload() {
                // Clear the server's cache for the file.
                    // Note that this request includes a header telling the client to clear cache too.
                const url = '/Post_Modules/ClearCachedFile.js&cache=false';
                const data = JSON.stringify({ path: CurrentBaseDocument });
                post(url, data).then((val) => {
                    // Reload the page.
                    Load(CurrentBaseDocument);
                })
            }
    
            // Check every 100ms to see if the page params changed.
            /*
            async function CheckLoop() {
                do {
                    let lastPageParams = document.location.search;
                    await new Promise(res => {
                        setTimeout(() => {
                            if (document.location.search != lastPageParams)
                                UpdatePageFromParams();
                            
                            res();
                        }, 100)
                    });
                } while (true);
            }
            CheckLoop();
            */
        </script>
        <link rel="stylesheet" href="ObsidianViewer.css">
    </head>
    <body onload="UpdatePageFromParams()">
        <div id="ButtonContainer" hidden>
            <button onclick="GetSuggestedLinks()" class="DarkButton" title="Go Home!">🏠</button>
            <button onclick="Reload()" class="DarkButton" title="Reload the current page!">🔄</button>
        </div>
        <div id="Home" class="Display">
            Loading...
        </div>
        <div id="Content" class="Display">
    
        </div>
    </body>
    <script>
        // Save key tracking for after the page has loaded pretty much.
        var pressedKeys = [];
        window.onkeyup = function(e) { pressedKeys[e.keyCode] = false; }
        window.onkeydown = function(e) { pressedKeys[e.keyCode] = true; }
    </script>
</html>