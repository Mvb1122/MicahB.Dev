<!DOCTYPE html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="A viewer for my Obsidian Markdown files.">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MicahB.Dev | Markdown Viewer</title>
    <script>
        const backend = "."
        async function GetSuggestedLinks() {
            const files = await (await fetch(backend + "/Modules/Search.js&term=.md")).json();
            const ul = document.createElement("ul");
            files.result.forEach(file => {
                if (file.includes("md")) {
                    const part = document.createElement("li");
                    const link = document.createElement("a");
                    link.text = file.substring(0, file.indexOf(".md"));
                    link.onclick = function() { 
                        Load(file);
                        return pressedKeys != undefined ? pressedKeys[16] : false;
                    };

                    const newAddr = window.location.href.split('?')[0] + "?file=" + file;
                    link.href = newAddr;

                    part.appendChild(link);
                    ul.appendChild(part);
                }
            });
            // Clear and add text.
            document.getElementById("Home").innerHTML = "<h1>Checkout these pages:</h1>"
            document.getElementById("Home").appendChild(ul);
            document.getElementById("Home").hidden = false;
            document.getElementById("Content").hidden = true;
            document.getElementById("ButtonContainer").hidden = true;
        }
        
        /**
         * @returns {Promise<Response>}
         */
        async function post(URL, data) {
            return fetch(backend + URL, {
                method: "POST",
                body: data
            })
        }

        function ProcessLink(match) {
            const href = match.href.toLowerCase();
            console.log("Processing link to " + href)
            if (href.includes("micahb.dev") && href.includes(".md")) {
                // Check if there's an ! before the link. If so, embed the page.
                const newPage = decodeURI(match.href.substring(match.href.indexOf("=") + 1));
                if (match.getAttribute("embed") == "true") {
                    const newPart = document.createElement("div");
                    const docName = newPage.substring(newPage.lastIndexOf("\\") + 1);
                    newPart.id = "Embed_" + docName + "_" + Math.floor(Math.random() * 10000);
                    newPart.setAttribute("embed", true);
                    newPart.setAttribute("document", docName)
                    match.parentElement.replaceChild(newPart, match); // Parent is never null here. 

                    // Note, use a settimeout for loading in order to ensure that this document finishes processing first. 
                    Load(newPage, newPart.id);
                } else {
                    // Allows for crawling links while also cutting down on load times. 
                    match.onclick = function () {
                        Load(newPage);

                        // Return true: Calls href. Return false: Does nothing.
                        // Allow for shift-click to open in a new tab.
                        return pressedKeys != undefined ? pressedKeys[16] : false; // Keycode 16 is shift.
                    };

                    // Change the HREF to point to this page with that new address.
                    const newAddr = window.location.href.split('?')[0] + "?file=" + match.href.substring(match.href.indexOf("=") + 1);
                    match.href = newAddr;
                }
            } else {
                match.setAttribute("external", true);

                // Follow it with an after image.
                const AfterImage = document.createElement("externallinkafterimage");
                match.after(AfterImage);
            }
        }

        async function Load(path, LoadToElement = "Content") {
            new Promise(async (res) => {
                try {
                    // First, fetch the HTML from the server and load it in.
                    const isBaseDocument = LoadToElement == "Content";

                    const page = await (await post("/Post_Modules/GetMDHTML.js", JSON.stringify({ location: path }))).text();
                    document.getElementById(LoadToElement).innerHTML = page;

                    // Next, put the title of the page on screen.
                    if (isBaseDocument) {
                        const title = document.createElement("h1");
                        title.innerText = path.substring(path.lastIndexOf("\\") + 1, path.includes(".md") ? path.indexOf(".md") : path.length);
                        document.getElementById(LoadToElement).prepend(title);
                    }

                    // Unhide the content panel and hide the home panel.
                    document.getElementById(LoadToElement).removeAttribute("hidden");
                    document.getElementById("Home").setAttribute("hidden", true);
                        // Also show buttons.
                    document.getElementById("ButtonContainer").removeAttribute("hidden");

                    // Replace <a>'s with working ones.
                    const Anchors = document.getElementById(LoadToElement).getElementsByTagName("a"); // document.getElementById(LoadToElement).innerHTML.match(/<\s*a[^>]*>(.*?)<\s*\/\s*a\s*>/g);
                    for (let AnchorIndex = 0; AnchorIndex < Anchors.length; AnchorIndex++) {
                        const match = Anchors[AnchorIndex];

                        // Wait for 10ms to ensure that the next one is also scheduled.
                        setTimeout(() => {
                            ProcessLink(match)
                        }, 10);
                    }

                    const Quotes = document.getElementById(LoadToElement).getElementsByTagName("blockquote");
                    for (let i = 0; i < Quotes.length; i++) {
                        let quote = Quotes[i];
                        // Look for a style tag:
                        /** @type {String} */
                        const text = quote.innerText;
                        let title = text.match(/\[![A-Za-z0-9]+\]/);
                        if (title != null) {
                            const match = title[0];
                            quote.innerText = quote.innerText.replace(title[0], "");
                            const param = match.substring(2, match.length - 1);
                            quote.setAttribute(param, true);
                            quote.innerHTML = `<h3 style="margin: 0%">${param.substring(0, 1).toUpperCase()}${param.substring(1)}</h3>` + quote.innerHTML;
                        }
                    }

                    const Tags = document.getElementById(LoadToElement).getElementsByTagName("p");
                    tagLoop:
                    for (let i = 0; i < Tags.length; i++) {
                        const match = Tags[i].innerText.match(/\{TAG:.+\}/);
                        if (match != null) {
                            const tag = match[0], inside = tag.substring(5, tag.length - 1);

                            const NewTag = document.createElement("a");
                            NewTag.setAttribute("tag", true);
                            NewTag.innerHTML = `<b>#</b>${inside}`;

                            /*
                            for (let i = 0; i < Tags[i].children; i++) {
                                if (Tags[i].children[i].innerText.includes(tag)) {
                                    Tags[i].children[i].innerText = Tags[i].children[i].innerText.replace(tag, "");
                                    Tags[i].prepend(NewTag);
                                    continue tagLoop;
                                }
                            }
                            */

                            Tags[i].innerHTML = Tags[i].innerHTML.replace(tag, "");
                            Tags[i].prepend(NewTag);
                        }
                    }

                    
                    // Only update history and show backlinks for base document.
                    if (isBaseDocument) {
                        // Update the page title.
                        const FileName = path.substring(path.lastIndexOf("\\") + 1);
                        document.title = "MicahB.Dev | " + FileName;
                        
                        // Update history so people can share links easily. 
                        window.history.pushState({}, null, window.location.href.split('?')[0] + "?file=" + path);
                        
                        // Finally, add the backlinks.
                        const backlinks = await (await post("/Post_Modules/GetBacklinks.js", JSON.stringify({ path: FileName.substring(0, FileName.length - 3) }))).json();
                        if (backlinks.successful && backlinks.links.length > 0) {
                            const BackLinkDiv = document.createElement("div");
                            const Header = document.createElement("h2");
                            Header.innerText = "Backlinks: ";
                            BackLinkDiv.appendChild(Header);
                            const List = document.createElement("ul");
                            backlinks.links.forEach(link => {
                                const item = document.createElement("li");
                                const el = document.createElement("a");

                                el.onclick = function() { 
                                    Load(link);
                                }
                                el.innerText = link;

                                item.appendChild(el);
                                List.appendChild(item);
                            });
                            BackLinkDiv.appendChild(List);

                            document.getElementById(LoadToElement).appendChild(BackLinkDiv);
                        }
                    }
                } catch (e) {
                    console.log(e)
                    res();
                }
            })
        }

        function UpdatePageFromParams() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has("file")) {
                setTimeout(() => {
                    Load(urlParams.get("file"));
                }, 500);
            }
        }
        UpdatePageFromParams();

        // Check every 100ms to see if the page params changed.
        /*
        async function CheckLoop() {
            do {
                let lastPageParams = document.location.search;
                await new Promise(res => {
                    setTimeout(() => {
                        if (document.location.search != lastPageParams)
                            UpdatePageFromParams();
                        
                        res();
                    }, 100)
                });
            } while (true);
        }
        CheckLoop();
        */
    </script>
    <link rel="stylesheet" href="ObsidianViewer.css">
</head>
<body onload="GetSuggestedLinks()">
    <div id="ButtonContainer" hidden>
        <button onclick="GetSuggestedLinks()" id="HomeButton">🏠</button>
    </div>
    <div id="Home" class="Display">
        Loading...
    </div>
    <div id="Content" class="Display">

    </div>
</body>
<script>
    // Save key tracking for after the page has loaded pretty much.
    var pressedKeys = {};
    window.onkeyup = function(e) { pressedKeys[e.keyCode] = false; }
    window.onkeydown = function(e) { pressedKeys[e.keyCode] = true; }
</script>