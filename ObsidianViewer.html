<!DOCTYPE html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="description" content="A viewer for my Obsidian Markdown files.">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MicahB.Dev | Markdown Viewer</title>
    <script>
        const backend = "https://micahb.dev"
        async function GetSuggestedLinks() {
            const files = await (await fetch(backend + "/Modules/Search.js&term=.md")).json();
            const ul = document.createElement("ul");
            files.result.forEach(file => {
                if (file.includes("md")) {
                    const part = document.createElement("li");
                    const link = document.createElement("a");
                    link.text = file.substring(0, file.indexOf(".md"));
                    link.onclick = function() { Load(file); }
                    part.appendChild(link);
                    ul.appendChild(part);
                }
            });
            // Clear and add text.
            document.getElementById("Home").innerHTML = "<h1>Checkout these pages:</h1>"
            document.getElementById("Home").appendChild(ul);
            document.getElementById("Home").hidden = false;
            document.getElementById("Content").hidden = true;
            document.getElementById("ButtonContainer").hidden = true;
        }
        
        /**
         * @returns {Promise<Response>}
         */
        async function post(URL, data) {
            return fetch(backend + URL, {
                method: "POST",
                body: data
            })
        }

        async function Load(path) {
            // First, fetch the HTML from the server and load it in.
            const page = await (await post("/Post_Modules/GetMDHTML.js", JSON.stringify({ location: path }))).text();
            document.getElementById("Content").innerHTML = page;

            // Next, put the title of the page on screen.
            const title = document.createElement("h1");
            title.innerText = path.substring(path.lastIndexOf("\\") + 1, path.includes(".md") ? path.indexOf(".md") : path.length);
            document.getElementById("Content").prepend(title);

            // Unhide the content panel and hide the home panel.
            document.getElementById("Content").hidden = false;
            document.getElementById("Home").hidden = true;
                // Also show buttons.
            document.getElementById("ButtonContainer").hidden = false;
                // Update history so people can share links easily. 
            window.history.pushState({}, null, window.location.href.split('?')[0] + "?file=" + path);

            // Replace <a>'s with working ones.
            const matches = document.getElementById("Content").getElementsByTagName("a"); // document.getElementById("Content").innerHTML.match(/<\s*a[^>]*>(.*?)<\s*\/\s*a\s*>/g);
            for (let i = 0; i < matches.length; i++) {
                const match = matches[i];
                const href = match.href.toLowerCase();
                if (href.includes("micahb.dev") && href.includes(".md")) {
                    const newPage = decodeURI(match.href.substring(match.href.indexOf("=") + 1));
                    match.onclick = function() { 
                        Load(newPage) 
                    };
                    match.removeAttribute("href");
                } else {
                    match.setAttribute("external", true);

                    // Follow it with an after image.
                    const AfterImage = document.createElement("externallinkafterimage");
                    match.after(AfterImage);
                }
            }
            
            const Quotes = document.getElementById("Content").getElementsByTagName("blockquote");
            for (let i = 0; i < Quotes.length; i++) {
                let quote = Quotes[i];
                // Look for a style tag:
                /** @type {String} */
                const text = quote.innerText;
                let title = text.match(/\[![A-Za-z0-9]+\]/);
                if (title != null) {
                    const match = title[0];
                    quote.innerText = quote.innerText.replace(title[0], "");
                    const param = match.substring(2, match.length - 1);
                    quote.setAttribute(param, true);
                    quote.innerHTML = `<h3 style="margin: 0%">${param.substring(0, 1).toUpperCase()}${param.substring(1)}</h3>` + quote.innerHTML;
                }
            }

            const Tags = document.getElementById("Content").getElementsByTagName("p");
            tagLoop:
            for (let i = 0; i < Tags.length; i++) {
                const match = Tags[i].innerText.match(/\{TAG:[A-Za-z0-9]+\}/);
                if (match != null) {
                    const tag = match[0], inside = tag.substring(5, tag.length - 1);

                    const NewTag = document.createElement("a");
                    NewTag.setAttribute("tag", true);
                    NewTag.innerHTML = `<b>#</b>${inside}`;

                    /*
                    for (let i = 0; i < Tags[i].children; i++) {
                        if (Tags[i].children[i].innerText.includes(tag)) {
                            Tags[i].children[i].innerText = Tags[i].children[i].innerText.replace(tag, "");
                            Tags[i].prepend(NewTag);
                            continue tagLoop;
                        }
                    }
                    */

                    Tags[i].innerHTML = Tags[i].innerHTML.replace(tag, "");
                    Tags[i].prepend(NewTag);
                }
            }

            document.title = "MicahB.Dev | " + path.substring(path.lastIndexOf("\\") + 1);
        }

        function UpdatePageFromParams() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has("file")) {
                setTimeout(() => {
                    Load(urlParams.get("file"));
                }, 500);
            }
        }
        UpdatePageFromParams();

        // Check every 100ms to see if the page params changed.
        /*
        async function CheckLoop() {
            do {
                let lastPageParams = document.location.search;
                await new Promise(res => {
                    setTimeout(() => {
                        if (document.location.search != lastPageParams)
                            UpdatePageFromParams();
                        
                        res();
                    }, 100)
                });
            } while (true);
        }
        CheckLoop();
        */
    </script>
    <link rel="stylesheet" href="ObsidianViewer.css">
</head>
<body onload="GetSuggestedLinks()">
    <div id="ButtonContainer" hidden>
        <button onclick="GetSuggestedLinks()" id="HomeButton">üè†</button>
    </div>
    <div id="Home" class="Display">
        Loading...
    </div>
    <div id="Content" class="Display">

    </div>
</body>