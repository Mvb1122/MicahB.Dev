<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="description" content="A viewer for my Obsidian Markdown files.">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MicahB.Dev | Markdown Viewer</title>
    <script>
        const backend = "https://micahb.dev"
        async function GetSuggestedLinks() {
            const files = await (await fetch(backend + "/Modules/Search.js&term=.md")).json();
            const ul = document.createElement("ul");
            files.result.forEach(file => {
                if (file.includes("md")) {
                    const part = document.createElement("li");
                    const link = document.createElement("a");
                    link.text = file.substring(0, file.indexOf(".md"));
                    link.onclick = function() { Load(file); }
                    part.appendChild(link);
                    ul.appendChild(part);
                }
            });
            // Clear and add text.
            document.getElementById("Home").innerHTML = "<h1>Checkout these pages:</h1>"
            document.getElementById("Home").appendChild(ul);
            document.getElementById("Home").hidden = false;
            document.getElementById("Content").hidden = true;
            document.getElementById("HomeButton").hidden = true;
        }
        
        /**
         * @returns {Promise<Response>}
         */
        async function post(URL, data) {
            return fetch(backend + URL, {
                method: "POST",
                body: data
            })
        }

        async function Load(path) {
            const page = await (await post("/Post_Modules/GetMDHTML.js", JSON.stringify({ location: path }))).text();
            document.getElementById("Content").innerHTML = page;
            document.getElementById("Content").hidden = false;
            document.getElementById("Home").hidden = true;
            document.getElementById("HomeButton").hidden = false;
            window.history.pushState({}, null, window.location.href.split('?')[0] + "?file=" + path);

            // Replace <a>'s with working ones.
            const matches = document.getElementById("Content").getElementsByTagName("a"); // document.getElementById("Content").innerHTML.match(/<\s*a[^>]*>(.*?)<\s*\/\s*a\s*>/g);
            for (let i = 0; i < matches.length; i++) {
                const match = matches[i];
                if (match.href.includes("GetMDHTML")) {
                    const newPage = decodeURI(match.href.substring(match.href.indexOf("=") + 1));
                    match.onclick = function() { 
                        Load(newPage) 
                    };
                    match.removeAttribute("href");
                } else {
                    match.setAttribute("external", true);

                    // Follow it with an after image.
                    const AfterImage = document.createElement("externallinkafterimage");
                    match.after(AfterImage);
                }
            }
            
            const Quotes = document.getElementById("Content").getElementsByTagName("blockquote");
            for (let i = 0; i < Quotes.length; i++) {
                let quote = Quotes[i];
                // Look for a style tag:
                /** @type {String} */
                const text = quote.innerText;
                let Query = text.match(/\[![A-Za-z0-9]+\]/);
                if (Query != null) {
                    const match = Query[0];
                    quote.innerText = quote.innerText.replace(Query[0], "");
                    const param = match.substring(2, match.length - 1);
                    quote.setAttribute(param, true);
                    quote.innerHTML = `<h3 style="margin: 0%">${param.substring(0, 1).toUpperCase()}${param.substring(1)}</h3>` + quote.innerHTML;
                }
            }

            document.title = "MicahB.Dev | " + path.substring(path.lastIndexOf("\\") + 1);
        }

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has("file")) {
            setTimeout(() => {
                Load(urlParams.get("file"));
            }, 500);
        }
    </script>
    <link rel="stylesheet" href="ObsidianViewer.css">
</head>
<body onload="GetSuggestedLinks()">
    <div class="ButtonContainer">
        <button onclick="GetSuggestedLinks()" id="HomeButton" hidden>üè†</button>
    </div>
    <div id="Home" class="Display">
        Loading...
    </div>
    <div id="Content" class="Display">

    </div>
</body>